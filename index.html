<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AIYDIWDWY v2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    body {margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#121212;color:#e0e0e0;display:flex;justify-content:center;padding:10px; box-sizing: border-box;}
    .app {width:100%;max-width:500px;background:#1e1e1e;border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.8); border: 1px solid #333;}
    h1 {text-align:center;margin:5px 0 20px;font-size:26px; letter-spacing: 1px;}
    
    /* Inputs & Buttons */
    input, button {width:100%;padding:14px;margin-bottom:12px;border-radius:10px;border:none;font-size:16px;box-sizing: border-box;}
    input {background:#2c2c2c; color:#fff; border: 1px solid #444;}
    input:focus {outline: 2px solid #6a1b9a;}
    
    button {font-weight: bold; transition: all 0.2s;}
    button:active {transform: scale(0.98);}
    button.primary {background:linear-gradient(45deg, #6a1b9a, #8e24aa);color:white;box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);}
    button.secondary {background:linear-gradient(45deg, #880e4f, #ad1457);color:white;box-shadow: 0 4px 15px rgba(136, 14, 79, 0.4);}
    button.ghost {background: transparent; border: 1px solid #444; color: #aaa;}
    
    /* Calendar Grid */
    .calendar-header {display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
    .calendar {display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .day-name {text-align:center;font-size:12px;opacity:0.6; text-transform: uppercase; letter-spacing: 1px;}
    
    .day {
        background:#2a2a2a;
        min-height: 50px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-radius:10px; cursor:pointer; font-size:16px; position: relative;
        border: 1px solid transparent;
        transition: background 0.2s;
    }
    
    /* Stati dei giorni */
    .casa-cicci {background:#4a148c; border-color: #7c43bd;} /* Viola scuro */
    .casa-cucci {background:#880e4f; border-color: #c2185b;} /* Rosso scuro */
    .missed {opacity: 0.4; background: #333 !important; border: 1px dashed #777 !important; color: #888;}
    
    .time {font-size:10px; background: rgba(0,0,0,0.4); padding: 2px 4px; border-radius: 4px; margin-top: 2px;}
    
    /* Modale */
    .modal {position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center; z-index: 100;}
    .modal-content {background:#222;padding:25px;border-radius:16px;width:90%;max-width:340px; text-align: center; border: 1px solid #444;}
    
    /* Pulsanti selezione nella modale */
    .place-selector {display: flex; gap: 10px; margin-bottom: 15px;}
    .place-btn {flex: 1; opacity: 0.5; border: 2px solid transparent;}
    .place-btn.active {opacity: 1; border-color: #fff; transform: scale(1.05);}
    
    .stats {font-size:13px;margin-top:20px;padding-top:15px; border-top: 1px solid #333; display: flex; justify-content: space-around; color: #bbb;}
    .label {font-size: 12px; display: block; text-align: left; margin-bottom: 4px; color: #aaa;}
</style>
</head>
<body>

<div class="app">
    <h1>üíú AIYDIWDWY</h1>

    <div id="login">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button class="primary" onclick="login()">Accedi / Registrati</button>
    </div>

    <div id="main" style="display:none;">
        <div class="calendar-header">
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(-1)">‚óÄ</button>
            <strong id="month" style="font-size: 18px;"></strong>
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(1)">‚ñ∂</button>
        </div>

        <div class="calendar" id="calendar"></div>

        <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
            <button class="primary" onclick="shiftScheduleFromToday()">üòÖ Oggi √® saltato: Slitta tutto!</button>
            <button class="secondary" onclick="forceBalanceMonth()">‚öñÔ∏è Riscrivi Mese (Alternanza Perfetta)</button>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="modalDate" style="margin-top: 0;"></h3>
        
        <label class="label">Dove dormiamo?</label>
        <div class="place-selector">
            <button id="btn-cicci" class="place-btn" style="background:#4a148c; color:white;" onclick="setPlace('casa-cicci')">Cicci</button>
            <button id="btn-cucci" class="place-btn" style="background:#880e4f; color:white;" onclick="setPlace('casa-cucci')">Cucci</button>
        </div>

        <label class="label">Orari (Opzionale)</label>
        <div style="display:flex; gap:10px;">
            <input type="time" id="startTime">
            <input type="time" id="endTime">
        </div>

        <div style="display:flex; gap:10px; margin-top: 10px;">
            <button class="primary" onclick="saveDay()">Salva</button>
            <button class="ghost" onclick="closeModal()">Chiudi</button>
        </div>
        <button class="ghost" style="margin-bottom:0; font-size:12px; color:#d32f2f;" onclick="markAsMissedSingle()">Segna come saltato solo questo giorno</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey:"AIzaSyCEtnsKsL6EkGmZsgx4lHEHv-CiZ5L3H98",
        authDomain:"aiydiwdwy-aiygiwgwy.firebaseapp.com",
        projectId:"aiydiwdwy-aiygiwgwy",
        storageBucket:"aiydiwdwy-aiygiwgwy.firebasestorage.app",
        messagingSenderId:"510624883472",
        appId:"1:510624883472:web:d85e00839e26c8e41c3b95"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    let current=new Date();
    let selectedDate=null;
    let tempPlace=null;

    // ---------------- AUTH ----------------
    auth.onAuthStateChanged(user=>{
        if(user){ 
            document.getElementById('login').style.display='none'; 
            document.getElementById('main').style.display='block'; 
            initializeMonth(); 
        }
    });

    function login(){
        const emailVal=document.getElementById('email').value;
        const passwordVal=document.getElementById('password').value;
        if(!emailVal || !passwordVal){ alert("Inserisci email e password!"); return; }

        auth.signInWithEmailAndPassword(emailVal,passwordVal)
            .catch(()=> auth.createUserWithEmailAndPassword(emailVal,passwordVal)
            .catch(err=>alert(err.message)));
    }

    // ---------------- CALENDAR RENDER ----------------
    function render(dataFromFirebase=null){
        const cal=document.getElementById('calendar'); cal.innerHTML='';
        const y=current.getFullYear(), m=current.getMonth();
        
        // Titolo Mese
        const monthName = current.toLocaleDateString('it-IT',{month:'long',year:'numeric'});
        document.getElementById('month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

        // Intestazione giorni
        ['L','M','M','G','V','S','D'].forEach(d=>{let e=document.createElement('div'); e.textContent=d; e.className='day-name'; cal.appendChild(e);});
        
        // Spazi vuoti inizio mese
        const first=new Date(y,m,1).getDay()||7; 
        for(let i=1;i<first;i++) cal.appendChild(document.createElement('div'));
        
        const days=new Date(y,m+1,0).getDate();
        
        for(let d=1;d<=days;d++){
            const key=`${y}-${m+1}-${d}`;
            const el=document.createElement('div'); 
            el.className='day'; 
            el.innerHTML = `<strong>${d}</strong>`;
            el.onclick=()=>openModal(key);
            
            if(dataFromFirebase && dataFromFirebase[key]){
                const data=dataFromFirebase[key];
                
                if(data.missed) {
                    el.classList.add('missed');
                } else if(data.place) {
                    el.classList.add(data.place);
                }
                
                if(!data.missed && data.start && data.end){
                    el.innerHTML+=`<div class='time'>${data.start}-${data.end}</div>`;
                }
            }
            cal.appendChild(el);
        }
        updateStats();
    }

    // ---------------- MODAL LOGIC ----------------
    function openModal(date){ 
        selectedDate=date; 
        tempPlace=null; // Reset selezione
        
        // Formatta data leggibile
        const parts = date.split('-');
        const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
        document.getElementById('modalDate').textContent = dateObj.toLocaleDateString('it-IT', {weekday:'long', day:'numeric', month:'long'});
        
        // Reset UI
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        updatePlaceUI();
        
        // Carica dati esistenti se ci sono
        db.collection('calendar').doc(date).get().then(doc => {
            if(doc.exists){
                const data = doc.data();
                if(data.place) setPlace(data.place);
                if(data.start) document.getElementById('startTime').value = data.start;
                if(data.end) document.getElementById('endTime').value = data.end;
            }
        });

        document.getElementById('modal').style.display='flex'; 
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }

    function setPlace(p){ 
        tempPlace=p; 
        updatePlaceUI();
    }

    function updatePlaceUI(){
        document.getElementById('btn-cicci').classList.remove('active');
        document.getElementById('btn-cucci').classList.remove('active');
        if(tempPlace === 'casa-cicci') document.getElementById('btn-cicci').classList.add('active');
        if(tempPlace === 'casa-cucci') document.getElementById('btn-cucci').classList.add('active');
    }

    function saveDay(){
        if(!tempPlace){ alert("Per favore seleziona Casa Cicci o Casa Cucci"); return; }
        
        // Orari opzionali: se vuoti salviamo stringa vuota
        const s = document.getElementById('startTime').value;
        const e = document.getElementById('endTime').value;

        db.collection('calendar').doc(selectedDate).set({
            place: tempPlace,
            start: s ? s : "", 
            end: e ? e : "",
            missed: false
        }).then(closeModal);
    }

    function markAsMissedSingle() {
        if(confirm("Segnare questo giorno come 'Saltato' senza spostare gli altri?")) {
            db.collection('calendar').doc(selectedDate).update({missed: true, place: null, start: "", end: ""}).then(closeModal);
        }
    }

    // ---------------- FUNZIONI SMART ----------------

    // 1. Bilanciamento Alternato Perfetto (A-B-A-B)
    function forceBalanceMonth(){
        if(!confirm("Questo riscriver√† l'intero mese visualizzato alternando le case (1 notte a testa) partendo dal giorno 1. Continuare?")) return;

        const y=current.getFullYear(), m=current.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const batch = db.batch();

        for(let d=1; d<=days; d++){
            const key=`${y}-${m+1}-${d}`;
            // Pari = Cicci, Dispari = Cucci (o viceversa, si pu√≤ cambiare)
            const place = (d % 2 !== 0) ? 'casa-cicci' : 'casa-cucci';
            const ref = db.collection('calendar').doc(key);
            batch.set(ref, { place: place, start: "", end: "", missed: false });
        }

        batch.commit().then(() => alert("Calendario bilanciato perfettamente!"));
    }

    // 2. Slittamento Intelligente (Shift Schedule)
    // Se oggi non abbiamo seguito il piano, segna oggi come missed e sposta tutto di +1
    function shiftScheduleFromToday(){
        const today = new Date();
        const y = today.getFullYear();
        const m = today.getMonth() + 1;
        const d = today.getDate();
        const todayKey = `${y}-${m}-${d}`;

        if(!confirm(`Segnare oggi (${d}/${m}) come 'Saltato' e spostare tutti i piani futuri di un giorno in avanti?`)) return;

        db.collection('calendar').orderBy(firebase.firestore.FieldPath.documentId()).get().then(snap => {
            const updates = {};
            let foundToday = false;
            let previousData = null;

            // Iteriamo tutti i documenti
            snap.docs.forEach((doc, index) => {
                const key = doc.id;
                
                // Logica: Troviamo oggi.
                if (key === todayKey) {
                    foundToday = true;
                    // Salviamo il piano di oggi per darlo a domani
                    previousData = doc.data(); 
                    // Oggi diventa missed
                    updates[key] = { missed: true, place: null, start: "", end: "" };
                } 
                else if (foundToday) {
                    // Siamo nel futuro.
                    // Prendiamo il piano corrente di questo giorno per passarlo al prossimo
                    const currentData = doc.data();
                    
                    // Assegniamo a questo giorno il piano del giorno precedente
                    if (previousData) {
                        updates[key] = previousData;
                    }
                    
                    // Aggiorniamo previousData per il prossimo giro
                    previousData = currentData;
                }
            });

            // Applichiamo le modifiche in batch (o loop se batch √® troppo complesso qui)
            const batch = db.batch();
            Object.keys(updates).forEach(k => {
                batch.set(db.collection('calendar').doc(k), updates[k]);
            });
            return batch.commit();
        }).then(() => alert("Piani slittati con successo!"));
    }

    // ---------------- UTILS ----------------
    function initializeMonth(){
        // Listener Realtime
        db.collection('calendar').onSnapshot(snapshot=>{
            let data={};
            snapshot.docs.forEach(doc=>{ data[doc.id]=doc.data(); });
            render(data);
        });
    }

    function changeMonth(n){ 
        current.setMonth(current.getMonth()+n); 
        // Triggera un re-render manuale vuoto finch√© il listener non scatta o per refreshare UI date
        initializeMonth(); 
    }

    function updateStats(){ 
        const y=current.getFullYear(), m=current.getMonth();
        // Conta solo i giorni del mese visualizzato
        db.collection('calendar').get().then(snap=>{ 
            let cicci=0, cucci=0; 
            snap.forEach(d=>{ 
                const dateParts = d.id.split('-');
                if(parseInt(dateParts[0]) === y && parseInt(dateParts[1]) === m+1 && !d.data().missed){
                    if(d.data().place==='casa-cicci') cicci++; 
                    if(d.data().place==='casa-cucci') cucci++; 
                }
            }); 
            document.getElementById('stats').innerHTML = `
                <div>üíú Cicci: <strong>${cicci}</strong></div>
                <div>üç∑ Cucci: <strong>${cucci}</strong></div>
            `; 
        }); 
    }
</script>
</body>
</html>
