<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AIYDIWDWY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    body {margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:#121212;color:#e0e0e0;display:flex;justify-content:center;padding:10px; box-sizing: border-box;}
    .app {width:100%;max-width:500px;background:#1e1e1e;border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.8); border: 1px solid #333;}
    h1 {text-align:center;margin:5px 0 20px;font-size:26px; letter-spacing: 1px;}
    
    /* Inputs, Buttons, Textarea */
    input, button, textarea {width:100%;padding:14px;margin-bottom:12px;border-radius:10px;border:none;font-size:16px;box-sizing: border-box;}
    input, textarea {background:#2c2c2c; color:#fff; border: 1px solid #444; font-family: inherit;}
    input:focus, textarea:focus {outline: 2px solid #6a1b9a;}
    textarea {resize: vertical; min-height: 80px;}

    button {font-weight: bold; transition: all 0.2s; cursor: pointer;}
    button:active {transform: scale(0.98);}
    button.primary {background:linear-gradient(45deg, #6a1b9a, #8e24aa);color:white;box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);}
    button.secondary {background:linear-gradient(45deg, #880e4f, #ad1457);color:white;box-shadow: 0 4px 15px rgba(136, 14, 79, 0.4);}
    button.ghost {background: transparent; border: 1px solid #444; color: #aaa;}
    
    /* Calendar Grid */
    .calendar-header {display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
    .calendar {display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .day-name {text-align:center;font-size:12px;opacity:0.6; text-transform: uppercase; letter-spacing: 1px;}
    
    .day {
        background:#2a2a2a; min-height: 60px;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        padding-top: 8px; border-radius:10px; cursor:pointer; font-size:16px; position: relative;
        border: 1px solid transparent; transition: background 0.2s; overflow: hidden;
    }
    
    /* Stati */
    .casa-cicci {background:#4a148c; border-color: #7c43bd;} 
    .casa-cucci {background:#880e4f; border-color: #c2185b;} 
    
    /* Stato "Da Decidere" */
    .da-decidere {
        background: #2a2a2a; 
        border: 2px dashed #666; 
        color: #ddd;
    }

    .missed {opacity: 0.4; background: #333 !important; border: 1px dashed #777 !important; color: #888;}
    
    .time {font-size:10px; background: rgba(0,0,0,0.4); padding: 2px 4px; border-radius: 4px; margin-top: 2px;}
    
    /* Icone (Nota e Foto) */
    .icons-container {
        display: flex; gap: 4px; position: absolute; bottom: 4px; right: 4px;
    }
    .icon-badge {font-size: 10px;}

    /* Modale */
    .modal {position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center; z-index: 100;}
    .modal-content {background:#222;padding:25px;border-radius:16px;width:90%;max-width:340px; text-align: center; border: 1px solid #444; max-height: 90vh; overflow-y: auto;}
    
    /* STILE PULSANTI LUOGO */
    .place-row {display: flex; gap: 10px; margin-bottom: 10px;} /* Riga per Cicci/Cucci */
    
    .place-btn {flex: 1; opacity: 0.5; border: 2px solid transparent; font-size: 14px; padding: 12px; margin-bottom: 0;}
    .place-btn.active {opacity: 1; border-color: #fff; transform: scale(1.02);}
    
    /* Bottone "Da Decidere" sotto */
    #btn-decidere {
        width: 100%; 
        background: #2a2a2a; 
        border: 1px dashed #666; 
        color: #aaa; 
        opacity: 0.7;
        margin-bottom: 20px; /* Spazio sotto prima degli orari */
    }
    #btn-decidere.active {
        opacity: 1; 
        border: 1px solid #fff; 
        background: #333; 
        color: #fff;
    }

    .stats {font-size:13px;margin-top:20px;padding-top:15px; border-top: 1px solid #333; display: flex; flex-wrap: wrap; justify-content: space-around; color: #bbb;}
    .label {font-size: 12px; display: block; text-align: left; margin-bottom: 4px; color: #aaa; margin-top: 15px;}
    
    /* Foto Preview */
    .photo-preview {width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; display: none;}
    .file-input-wrapper {position: relative; overflow: hidden; display: inline-block; width: 100%;}
    .file-input-wrapper input[type=file] {font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0;}
    .btn-upload {background: #333; color: white; border: 1px dashed #666;}
</style>
</head>
<body>

<div class="app">
    <h1>üíú AIYDIWDWY</h1>

    <div id="login">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button class="primary" onclick="login()">Accedi / Registrati</button>
    </div>

    <div id="main" style="display:none;">
        <div class="calendar-header">
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(-1)">‚óÄ</button>
            <strong id="month" style="font-size: 18px;"></strong>
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(1)">‚ñ∂</button>
        </div>

        <div class="calendar" id="calendar"></div>

        <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
            <button class="primary" onclick="shiftScheduleFromToday()">üòÖ Oggi √® saltato: Slitta tutto!</button>
            <button class="secondary" onclick="forceBalanceMonth()">‚öñÔ∏è Riscrivi Mese (Alternanza)</button>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="modalDate" style="margin-top: 0;"></h3>
        
        <label class="label" style="margin-top: 0;">Dove dormiamo?</label>
        
        <div class="place-row">
            <button id="btn-cicci" class="place-btn" style="background:#4a148c; color:white;" onclick="setPlace('casa-cicci')">Cicci</button>
            <button id="btn-cucci" class="place-btn" style="background:#880e4f; color:white;" onclick="setPlace('casa-cucci')">Cucci</button>
        </div>
        
        <button id="btn-decidere" onclick="setPlace('da-decidere')">ü§î Da Decidere</button>

        <label class="label">Orari (Opzionale)</label>
        <div style="display:flex; gap:10px;">
            <input type="time" id="startTime">
            <input type="time" id="endTime">
        </div>

        <label class="label">Descrizione del giorno</label>
        <textarea id="noteText" placeholder="Es: Cena fuori, Compleanno, etc..."></textarea>

        <label class="label">Foto (GitHub)</label>
        <img id="imgPreview" class="photo-preview" src="">
        <div class="file-input-wrapper">
            <button class="btn-upload">üì∑ Carica / Cambia Foto</button>
            <input type="file" id="photoInput" accept="image/*" onchange="previewFile()">
        </div>
        <input type="hidden" id="currentPhotoUrl">

        <div style="display:flex; gap:10px; margin-top: 20px;">
            <button id="saveBtn" class="primary" onclick="saveDay()">Salva</button>
            <button class="ghost" onclick="closeModal()">Chiudi</button>
        </div>
        <button class="ghost" style="margin-bottom:0; font-size:12px; color:#d32f2f;" onclick="markAsMissedSingle()">Segna come saltato solo oggi</button>
    </div>
</div>

<script>
    // --- CONFIGURAZIONE GITHUB ---
    const GH_USER = "PippoLordo"; 
    const GH_REPO = "CuddlesInBed";     
    const GH_TOKEN = "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"; 
    
    // --- CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey:"AIzaSyCEtnsKsL6EkGmZsgx4lHEHv-CiZ5L3H98",
        authDomain:"aiydiwdwy-aiygiwgwy.firebaseapp.com",
        projectId:"aiydiwdwy-aiygiwgwy",
        storageBucket:"aiydiwdwy-aiygiwgwy.firebasestorage.app",
        messagingSenderId:"510624883472",
        appId:"1:510624883472:web:d85e00839e26c8e41c3b95"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    let current=new Date();
    let selectedDate=null;
    let tempPlace=null;
    let fileToUpload=null;

    // ---------------- AUTH ----------------
    auth.onAuthStateChanged(user=>{
        if(user){ 
            document.getElementById('login').style.display='none'; 
            document.getElementById('main').style.display='block'; 
            initializeMonth(); 
        }
    });

    function login(){
        const emailVal=document.getElementById('email').value;
        const passwordVal=document.getElementById('password').value;
        if(!emailVal || !passwordVal){ alert("Dati mancanti!"); return; }

        auth.signInWithEmailAndPassword(emailVal,passwordVal)
            .catch(()=> auth.createUserWithEmailAndPassword(emailVal,passwordVal)
            .catch(err=>alert(err.message)));
    }

    // ---------------- CALENDAR RENDER ----------------
    function render(dataFromFirebase=null){
        const cal=document.getElementById('calendar'); cal.innerHTML='';
        const y=current.getFullYear(), m=current.getMonth();
        
        const monthName = current.toLocaleDateString('it-IT',{month:'long',year:'numeric'});
        document.getElementById('month').textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

        ['L','M','M','G','V','S','D'].forEach(d=>{let e=document.createElement('div'); e.textContent=d; e.className='day-name'; cal.appendChild(e);});
        
        const first=new Date(y,m,1).getDay()||7; 
        for(let i=1;i<first;i++) cal.appendChild(document.createElement('div'));
        
        const days=new Date(y,m+1,0).getDate();
        
        for(let d=1;d<=days;d++){
            const key=`${y}-${m+1}-${d}`;
            const el=document.createElement('div'); 
            el.className='day'; 
            el.innerHTML = `<strong>${d}</strong>`;
            el.onclick=()=>openModal(key);
            
            if(dataFromFirebase && dataFromFirebase[key]){
                const data=dataFromFirebase[key];
                
                if(data.missed) el.classList.add('missed');
                else if(data.place) el.classList.add(data.place);
                
                if(!data.missed && data.start && data.end){
                    el.innerHTML+=`<div class='time'>${data.start}-${data.end}</div>`;
                }

                // Icone per Descrizione (Nota) e Foto
                let iconsHtml = '<div class="icons-container">';
                if(data.note && data.note.trim() !== "") iconsHtml += '<span class="icon-badge">üìù</span>';
                if(data.photoUrl) iconsHtml += '<span class="icon-badge">üì∑</span>';
                iconsHtml += '</div>';
                el.innerHTML += iconsHtml;
            }
            cal.appendChild(el);
        }
        updateStats();
    }

    // ---------------- MODAL LOGIC ----------------
    function openModal(date){ 
        selectedDate=date; 
        tempPlace=null; 
        fileToUpload=null;
        
        const parts = date.split('-');
        const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
        document.getElementById('modalDate').textContent = dateObj.toLocaleDateString('it-IT', {weekday:'short', day:'numeric', month:'long'});
        
        // Reset Fields
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('noteText').value = '';
        document.getElementById('photoInput').value = '';
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('imgPreview').src = '';
        document.getElementById('currentPhotoUrl').value = '';
        document.getElementById('saveBtn').textContent = "Salva";
        document.getElementById('saveBtn').disabled = false;

        updatePlaceUI();
        
        db.collection('calendar').doc(date).get().then(doc => {
            if(doc.exists){
                const data = doc.data();
                if(data.place) setPlace(data.place);
                if(data.start) document.getElementById('startTime').value = data.start;
                if(data.end) document.getElementById('endTime').value = data.end;
                if(data.note) document.getElementById('noteText').value = data.note;
                
                if(data.photoUrl) {
                    document.getElementById('currentPhotoUrl').value = data.photoUrl;
                    document.getElementById('imgPreview').src = data.photoUrl;
                    document.getElementById('imgPreview').style.display = 'block';
                }
            }
        });

        document.getElementById('modal').style.display='flex'; 
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }
    function setPlace(p){ tempPlace=p; updatePlaceUI(); }

    function updatePlaceUI(){
        document.getElementById('btn-cicci').classList.remove('active');
        document.getElementById('btn-cucci').classList.remove('active');
        document.getElementById('btn-decidere').classList.remove('active');
        
        if(tempPlace === 'casa-cicci') document.getElementById('btn-cicci').classList.add('active');
        if(tempPlace === 'casa-cucci') document.getElementById('btn-cucci').classList.add('active');
        if(tempPlace === 'da-decidere') document.getElementById('btn-decidere').classList.add('active');
    }

    // ---------------- FOTO & UPLOAD (GITHUB) ----------------
    function previewFile() {
        const file = document.getElementById('photoInput').files[0];
        const preview = document.getElementById('imgPreview');
        
        if (file) {
            fileToUpload = file;
            const reader = new FileReader();
            reader.onload = function(e){
                preview.src = e.target.result;
                preview.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    async function uploadToGitHub(file) {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1]; 
                const fileName = `photos/${selectedDate}-${Date.now()}.jpg`;
                const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${fileName}`;
                
                try {
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${GH_TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: `Upload foto ${selectedDate}`,
                            content: base64Content
                        })
                    });
                    const json = await res.json();
                    
                    if(!res.ok) throw new Error(json.message || "Errore upload");

                    if(json.content && json.content.download_url) {
                        resolve(json.content.download_url);
                    } else {
                        resolve(`https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/${fileName}`);
                    }
                } catch(e) {
                    console.error(e);
                    alert("Errore upload GitHub: " + e.message);
                    resolve(null);
                }
            };
            reader.readAsDataURL(file);
        });
    }

    async function saveDay(){
        const btn = document.getElementById('saveBtn');
        btn.textContent = "Salvataggio...";
        btn.disabled = true;

        let finalPhotoUrl = document.getElementById('currentPhotoUrl').value;

        if(fileToUpload) {
            btn.textContent = "Caricamento foto su GitHub...";
            const uploadedUrl = await uploadToGitHub(fileToUpload);
            if(uploadedUrl) finalPhotoUrl = uploadedUrl;
            else {
                btn.textContent = "Errore Upload";
                btn.disabled = false;
                return; 
            }
        }

        const s = document.getElementById('startTime').value;
        const e = document.getElementById('endTime').value;
        const n = document.getElementById('noteText').value;

        db.collection('calendar').doc(selectedDate).set({
            place: tempPlace || null,
            start: s || "", 
            end: e || "",
            note: n || "",
            photoUrl: finalPhotoUrl || null,
            missed: false
        }).then(() => {
            closeModal();
            btn.textContent = "Salva";
            btn.disabled = false;
        });
    }

    function markAsMissedSingle() {
        if(confirm("Segna come 'Saltato'?")) {
            db.collection('calendar').doc(selectedDate).update({
                missed: true, place: null, start:"", end:"" 
            }).then(closeModal);
        }
    }

    // ---------------- LOGICHE AVANZATE ----------------
    function forceBalanceMonth(){
        if(!confirm("Riscrivi mese alternato (1 notte a testa)?")) return;
        const y=current.getFullYear(), m=current.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const batch = db.batch();

        for(let d=1; d<=days; d++){
            const key=`${y}-${m+1}-${d}`;
            const place = (d % 2 !== 0) ? 'casa-cicci' : 'casa-cucci';
            const ref = db.collection('calendar').doc(key);
            batch.set(ref, { place: place, missed: false }, {merge: true}); 
        }
        batch.commit().then(() => alert("Calendario bilanciato!"));
    }

    function shiftScheduleFromToday(){
        const today = new Date();
        const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;

        if(!confirm("Segnare OGGI saltato e slittare tutto il futuro?")) return;

        db.collection('calendar').orderBy(firebase.firestore.FieldPath.documentId()).get().then(snap => {
            const updates = {};
            let foundToday = false;
            let previousData = null;

            snap.docs.forEach((doc) => {
                const key = doc.id;
                if (key === todayKey) {
                    foundToday = true;
                    previousData = doc.data(); 
                    updates[key] = { ...previousData, missed: true, place: null, start: "", end: "" };
                } 
                else if (foundToday) {
                    const currentData = doc.data();
                    if (previousData) {
                        updates[key] = { ...previousData, missed: false };
                    }
                    previousData = currentData;
                }
            });

            const batch = db.batch();
            Object.keys(updates).forEach(k => {
                batch.set(db.collection('calendar').doc(k), updates[k]);
            });
            return batch.commit();
        }).then(() => alert("Piani slittati!"));
    }

    // ---------------- UTILS ----------------
    function initializeMonth(){
        db.collection('calendar').onSnapshot(snapshot=>{
            let data={};
            snapshot.docs.forEach(doc=>{ data[doc.id]=doc.data(); });
            render(data);
        });
    }
    function changeMonth(n){ current.setMonth(current.getMonth()+n); initializeMonth(); }
    
    function updateStats(){ 
        const y=current.getFullYear(), m=current.getMonth();
        db.collection('calendar').get().then(snap=>{ 
            let cicci=0, cucci=0, todecide=0; 
            snap.forEach(d=>{ 
                const p = d.id.split('-');
                if(parseInt(p[0])===y && parseInt(p[1])===m+1 && !d.data().missed){
                    if(d.data().place==='casa-cicci') cicci++; 
                    else if(d.data().place==='casa-cucci') cucci++; 
                    else if(d.data().place==='da-decidere') todecide++; 
                }
            }); 
            document.getElementById('stats').innerHTML = `
                <div>üíú Cicci: <strong>${cicci}</strong></div>
                <div>üç∑ Cucci: <strong>${cucci}</strong></div>
                <div>ü§î Decidere: <strong>${todecide}</strong></div>
            `; 
        }); 
    }
</script>
</body>
</html>
