<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AIYDIWDWY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="icon" type="image/x-icon" href="favicon.png">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    /* SFONDO GENERALE */
    body {
        margin:0;
        font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: url('sfondo.jpeg') no-repeat center center fixed; 
        background-size: cover;
        color:#e0e0e0;
        display:flex;
        justify-content:center;
        align-items: center; 
        padding:20px; 
        box-sizing: border-box;
        min-height: 100vh;
    }

    /* Contenitore App */
    .app {
        width:100%;
        max-width:500px;
        background:rgba(18, 18, 18, 0.92); 
        border-radius:20px;
        padding:25px;
        box-shadow:0 20px 60px rgba(0,0,0,0.9); 
        border: 1px solid rgba(255,255,255,0.1);
        backdrop-filter: blur(8px); 
    }

    h1 {text-align:center;margin:5px 0 20px;font-size:26px; letter-spacing: 1px; text-shadow: 0 2px 4px black;}
    
    input, button, textarea {width:100%;padding:14px;margin-bottom:12px;border-radius:10px;border:none;font-size:16px;box-sizing: border-box;}
    input, textarea {background:#2c2c2c; color:#fff; border: 1px solid #444; font-family: inherit;}
    input:focus, textarea:focus {outline: 2px solid #6a1b9a;}
    textarea {resize: vertical; min-height: 80px;}

    button {font-weight: bold; transition: all 0.2s; cursor: pointer;}
    button:active {transform: scale(0.98);}
    
    /* Stili Bottoni */
    button.primary {background:linear-gradient(45deg, #6a1b9a, #8e24aa);color:white;box-shadow: 0 4px 15px rgba(106, 27, 154, 0.4);}
    button.secondary {background:linear-gradient(45deg, #880e4f, #ad1457);color:white;box-shadow: 0 4px 15px rgba(136, 14, 79, 0.4);}
    button.tertiary {background: #333; color: #ccc; border: 1px dashed #555;}
    button.tertiary:hover {background: #444; color: #fff; border-color: #777;}
    button.ghost {background: transparent; border: 1px solid #444; color: #aaa;}
    
    /* Bottone Speciale Menu */
    button.gold {
        background: linear-gradient(45deg, #FFD700, #FFA500);
        color: #000;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        margin-bottom: 20px;
    }

    /* Calendar Grid */
    .calendar-header {display:flex;justify-content:space-between;align-items:center; margin-bottom: 10px;}
    .calendar {display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px;}
    .day-name {text-align:center;font-size:12px;opacity:0.6; text-transform: uppercase; letter-spacing: 1px;}
    
    .day {
        background:#2a2a2a; min-height: 60px;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
        padding-top: 8px; border-radius:10px; cursor:pointer; font-size:16px; position: relative;
        border: 1px solid transparent; transition: background 0.2s; overflow: hidden;
        text-shadow: 0 1px 3px rgba(0,0,0,0.9);
        font-weight: bold;
    }

    /* --- EFFETTO OGGI --- */
    .today {
        border: 2px solid #00e5ff !important; 
        box-shadow: 0 0 15px rgba(0, 229, 255, 0.6) !important;
        z-index: 10;
        animation: pulseToday 3s infinite;
    }
    @keyframes pulseToday {
        0% { box-shadow: 0 0 5px rgba(0, 229, 255, 0.4); }
        50% { box-shadow: 0 0 20px rgba(0, 229, 255, 0.8); }
        100% { box-shadow: 0 0 5px rgba(0, 229, 255, 0.4); }
    }
    
    /* STATI */
    .casa-cicci {background-image: url('cicci.jpeg') !important; background-size: cover !important; border: 1px solid rgba(255,255,255,0.3); color: #fff;}
    .casa-cucci {background-image: url('cucci.jpeg') !important; background-size: cover !important; border: 1px solid rgba(255,255,255,0.3); color: #fff;}
    .separati {background:#050505; border: 1px solid #333; color: #888;} 
    .fuori {background:#ef6c00; border-color: #e65100; color: #fff;} 
    .da-decidere {background: #2a2a2a; border: 2px dashed #666; color: #ddd;}
    .missed {opacity: 0.4; background: #333 !important; border: 1px dashed #777 !important; color: #888;}
    .speciale-blue {background: #039be5 !important; border: 1px solid #0288d1 !important; color: #fff !important; box-shadow: inset 0 0 15px rgba(255,255,255,0.2);}
    
    .time {font-size:10px; background: rgba(0,0,0,0.7); padding: 2px 4px; border-radius: 4px; margin-top: 2px; font-weight: normal;}
    .icons-container {display: flex; gap: 4px; position: absolute; bottom: 4px; right: 4px;}
    .icon-badge {font-size: 10px; text-shadow: none;}
    .special-star {position: absolute; top: 2px; left: 3px; font-size: 10px; text-shadow: 0 0 3px rgba(255,215,0, 1); filter: drop-shadow(0 0 2px black);}

    /* MODALE (Condivisa) */
    .modal {position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center; z-index: 100;}
    .modal-content {background:#222;padding:25px;border-radius:16px;width:90%;max-width:340px; text-align: center; border: 1px solid #444; max-height: 90vh; overflow-y: auto;}
    
    /* Lista Giorni Speciali */
    #specialListContent { text-align: left; margin-bottom: 15px; max-height: 60vh; overflow-y: auto; }
    .special-item {
        background: #333;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        border: 1px solid #444;
        transition: transform 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .special-item:hover { transform: scale(1.02); background: #3a3a3a; border-color: #ffd700; }
    .special-date { font-weight: bold; color: #ffd700; display: block; font-size: 14px; }
    .special-desc { font-size: 12px; color: #bbb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
    
    /* UI Modale Editor */
    .place-row {display: flex; gap: 10px; margin-bottom: 10px;} 
    .place-btn {flex: 1; opacity: 0.5; border: 2px solid transparent; font-size: 14px; padding: 12px; margin-bottom: 0;}
    .place-btn.active {opacity: 1; border-color: #fff; transform: scale(1.02);}
    
    #btn-speciale {width: 100%; background: #333; border: 1px solid #555; color: #aaa; margin-bottom: 10px;}
    #btn-speciale.active {background: #ffd700; color: #000; border-color: #fff; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);}
    #btn-decidere {width: 100%; background: #2a2a2a; border: 1px dashed #666; color: #aaa; opacity: 0.7; margin-bottom: 20px;}
    #btn-decidere.active {opacity: 1; border: 1px solid #fff; background: #333; color: #fff;}

    .stats {font-size:11px; margin-top:20px; padding-top:15px; border-top: 1px solid #333; display: flex; flex-wrap: wrap; justify-content: space-around; gap: 8px; color: #bbb;}
    .label {font-size: 12px; display: block; text-align: left; margin-bottom: 4px; color: #aaa; margin-top: 15px;}
    
    .photo-preview {width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; display: none;}
    .file-input-wrapper {position: relative; overflow: hidden; display: inline-block; width: 100%;}
    .file-input-wrapper input[type=file] {font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0;}
    .btn-upload {background: #333; color: white; border: 1px dashed #666;}
</style>
</head>
<body>

<div class="app">
    <h1>üíú AIYDIWDWY</h1>

    <div id="login">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button class="primary" onclick="login()">Accedi / Registrati</button>
    </div>

    <div id="main" style="display:none;">
        <div class="calendar-header">
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(-1)">‚óÄ</button>
            <strong id="month" style="font-size: 18px;"></strong>
            <button class="ghost" style="width:auto; margin:0;" onclick="changeMonth(1)">‚ñ∂</button>
        </div>

        <div class="calendar" id="calendar"></div>

        <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
            <button class="gold" onclick="openSpecialList()">üåü MENU GIORNI SPECIALI</button>

            <button class="primary" onclick="shiftScheduleFromToday()">üòÖ Oggi √® saltato: Slitta tutto!</button>
            <button class="secondary" onclick="forceBalanceMonth()">‚öñÔ∏è Riscrivi Mese (Alternanza)</button>
            <button class="tertiary" onclick="setAllToDecide()">ü§î Imposta Mese "Da Decidere"</button>
            <button class="ghost" style="color: #ef5350; border-color: #ef5350; margin-top: 10px;" onclick="resetMonthColors()">üóëÔ∏è Reset Colori Mese (Mantieni Foto/Note)</button>
        </div>
        
        <div class="stats" id="stats"></div>
    </div>
</div>

<div class="modal" id="specialListModal">
    <div class="modal-content">
        <h3 style="margin-top:0;">üåü Ricordi Speciali</h3>
        <div id="specialListContent">
            </div>
        <button class="ghost" onclick="closeSpecialList()">Chiudi</button>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <h3 id="modalDate" style="margin-top: 0;"></h3>
        
        <label class="label" style="margin-top: 0;">Dove dormiamo?</label>
        
        <div class="place-row">
            <button id="btn-cicci" class="place-btn" style="background:#4a148c; color:white;" onclick="setPlace('casa-cicci')">üíú Cicci</button>
            <button id="btn-cucci" class="place-btn" style="background:#880e4f; color:white;" onclick="setPlace('casa-cucci')">‚ù§Ô∏è Cucci</button>
        </div>

        <div class="place-row">
            <button id="btn-separati" class="place-btn" style="background:#000; color:#888; border-color:#333;" onclick="setPlace('separati')">üíî Separati</button>
            <button id="btn-fuori" class="place-btn" style="background:#ef6c00; color:white;" onclick="setPlace('fuori')">‚õ∫ Fuori</button>
        </div>

        <button id="btn-speciale" onclick="toggleSpecial()">‚ú® Speciale (‚≠ê)</button>
        <button id="btn-decidere" onclick="setPlace('da-decidere')">ü§î Da Decidere</button>

        <label class="label">Orari (Opzionale)</label>
        <div style="display:flex; gap:10px;">
            <input type="time" id="startTime">
            <input type="time" id="endTime">
        </div>

        <label class="label">Descrizione del giorno</label>
        <textarea id="noteText" placeholder="Es: Cena fuori, Compleanno, etc..."></textarea>

        <label class="label">Foto/Video (GitHub)</label>
        <img id="imgPreview" class="photo-preview" src="">
        <video id="videoPreview" class="photo-preview" controls style="display:none;"></video>
        
        <div class="file-input-wrapper">
            <button class="btn-upload">üì∑ Carica Foto/Video</button>
            <input type="file" id="photoInput" accept="image/*,video/*" onchange="previewFile()">
        </div>
        <input type="hidden" id="currentPhotoUrl">

        <div style="display:flex; gap:10px; margin-top: 20px;">
            <button id="saveBtn" class="primary" onclick="saveDay()">Salva</button>
            <button class="ghost" onclick="closeModal()">Chiudi</button>
        </div>
        <button class="ghost" style="margin-bottom:0; font-size:12px; color:#d32f2f;" onclick="markAsMissedSingle()">Segna come saltato solo oggi</button>
    </div>
</div>

<script>
    const GH_USER = "PippoLordo"; 
    const GH_REPO = "CuddlesInBed";     
    const part1 = "ghp_oSdiaDcgsJdgzwt";
    const part2 = "8ZZXycm5YqM01FU2K282y";
    const GH_TOKEN = part1 + part2;
    
    const firebaseConfig = {
        apiKey:"AIzaSyCEtnsKsL6EkGmZsgx4lHEHv-CiZ5L3H98",
        authDomain:"aiydiwdwy-aiygiwgwy.firebaseapp.com",
        projectId:"aiydiwdwy-aiygiwgwy",
        storageBucket:"aiydiwdwy-aiygiwgwy.firebasestorage.app",
        messagingSenderId:"510624883472",
        appId:"1:510624883472:web:d85e00839e26c8e41c3b95"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth();
    const db=firebase.firestore();

    let current=new Date();
    let selectedDate=null;
    let tempPlace=null;
    let tempSpecial=false; 
    let fileToUpload=null;
    let latestData = {}; 

    auth.onAuthStateChanged(user=>{
        if(user){ document.getElementById('login').style.display='none'; document.getElementById('main').style.display='block'; initializeMonth(); }
    });

    function login(){
        const emailVal=document.getElementById('email').value;
        const passwordVal=document.getElementById('password').value;
        if(!emailVal || !passwordVal){ alert("Dati mancanti!"); return; }
        auth.signInWithEmailAndPassword(emailVal,passwordVal).catch(()=> auth.createUserWithEmailAndPassword(emailVal,passwordVal).catch(err=>alert(err.message)));
    }

    function render(dataFromFirebase=null){
        if(dataFromFirebase) latestData = dataFromFirebase;
        const cal=document.getElementById('calendar'); cal.innerHTML='';
        const y=current.getFullYear(), m=current.getMonth();
        const todayDate = new Date(); 

        document.getElementById('month').textContent = current.toLocaleDateString('it-IT',{month:'long',year:'numeric'});

        ['L','M','M','G','V','S','D'].forEach(d=>{let e=document.createElement('div'); e.textContent=d; e.className='day-name'; cal.appendChild(e);});
        const first=new Date(y,m,1).getDay()||7; for(let i=1;i<first;i++) cal.appendChild(document.createElement('div'));
        const days=new Date(y,m+1,0).getDate();
        
        for(let d=1;d<=days;d++){
            const key=`${y}-${m+1}-${d}`;
            const el=document.createElement('div'); el.className='day'; el.innerHTML = `<strong>${d}</strong>`; el.onclick=()=>openModal(key);
            
            if(y === todayDate.getFullYear() && m === todayDate.getMonth() && d === todayDate.getDate()) {
                el.classList.add('today');
            }

            if(latestData && latestData[key]){
                const data=latestData[key];
                
                if(data.missed) {
                    el.classList.add('missed');
                } else {
                    if(data.isSpecial) {
                        if(data.place && data.place !== 'da-decidere') {
                            el.classList.add(data.place);
                        } else {
                            el.classList.add('speciale-blue');
                        }
                        el.innerHTML += '<span class="special-star">‚≠ê</span>';
                    } else {
                        if(data.place) el.classList.add(data.place);
                    }
                }

                if(!data.missed && data.start && data.end) el.innerHTML+=`<div class='time'>${data.start}-${data.end}</div>`;
                
                let iconsHtml = '<div class="icons-container">';
                if(data.note && data.note.trim() !== "") iconsHtml += '<span class="icon-badge">üìù</span>';
                if(data.photoUrl) iconsHtml += '<span class="icon-badge">üì∑</span>';
                iconsHtml += '</div>';
                el.innerHTML += iconsHtml;
            }
            cal.appendChild(el);
        }
        updateStats();
    }

    let lastRecordedDay = new Date().getDate();
    setInterval(() => {
        const now = new Date();
        if(now.getDate() !== lastRecordedDay) {
            lastRecordedDay = now.getDate();
            render(latestData);
        }
    }, 60000); 

    // ---------------- LISTA SPECIALI ----------------
    function openSpecialList(){
        const listDiv = document.getElementById('specialListContent');
        listDiv.innerHTML = '';
        
        // Filtra e ordina (dal pi√π recente)
        const specialDays = Object.keys(latestData)
            .filter(key => latestData[key].isSpecial)
            .sort((a,b) => new Date(b) - new Date(a));

        if(specialDays.length === 0){
            listDiv.innerHTML = '<div style="padding:10px; color:#777;">Nessun giorno speciale trovato.</div>';
        } else {
            specialDays.forEach(key => {
                const data = latestData[key];
                const dateObj = new Date(key);
                const niceDate = dateObj.toLocaleDateString('it-IT', {weekday:'short', day:'numeric', month:'long', year:'numeric'});
                
                const item = document.createElement('div');
                item.className = 'special-item';
                
                let icons = "";
                if(data.photoUrl) icons += "üì∑ ";
                if(data.note) icons += "üìù";

                item.innerHTML = `
                    <div>
                        <span class="special-date">‚≠ê ${niceDate}</span>
                        <span class="special-desc">${data.note || "Nessuna descrizione"}</span>
                    </div>
                    <div style="font-size:16px;">${icons}</div>
                `;
                item.onclick = () => {
                    closeSpecialList();
                    openModal(key);
                };
                listDiv.appendChild(item);
            });
        }
        
        document.getElementById('specialListModal').style.display = 'flex';
    }

    function closeSpecialList(){
        document.getElementById('specialListModal').style.display = 'none';
    }

    // ---------------- MODAL ----------------
    function openModal(date){ 
        selectedDate=date; tempPlace=null; tempSpecial=false; fileToUpload=null;
        const parts = date.split('-');
        const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
        document.getElementById('modalDate').textContent = dateObj.toLocaleDateString('it-IT', {weekday:'short', day:'numeric', month:'long'});
        
        document.getElementById('startTime').value = '';
        document.getElementById('endTime').value = '';
        document.getElementById('noteText').value = '';
        document.getElementById('photoInput').value = '';
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('videoPreview').style.display = 'none';
        document.getElementById('videoPreview').src = '';
        document.getElementById('imgPreview').src = '';
        document.getElementById('currentPhotoUrl').value = '';
        document.getElementById('saveBtn').textContent = "Salva";
        document.getElementById('saveBtn').disabled = false;

        updatePlaceUI(); updateSpecialUI();
        
        db.collection('calendar').doc(date).get().then(doc => {
            if(doc.exists){
                const data = doc.data();
                if(data.place) setPlace(data.place);
                if(data.isSpecial) { tempSpecial = true; updateSpecialUI(); }
                if(data.start) document.getElementById('startTime').value = data.start;
                if(data.end) document.getElementById('endTime').value = data.end;
                if(data.note) document.getElementById('noteText').value = data.note;
                
                if(data.photoUrl) {
                    document.getElementById('currentPhotoUrl').value = data.photoUrl;
                    const isVideo = data.photoUrl.match(/\.(mp4|mov|webm)$/i);
                    if(isVideo){
                        document.getElementById('videoPreview').src = data.photoUrl;
                        document.getElementById('videoPreview').style.display = 'block';
                    } else {
                        document.getElementById('imgPreview').src = data.photoUrl;
                        document.getElementById('imgPreview').style.display = 'block';
                    }
                }
            }
        });
        document.getElementById('modal').style.display='flex'; 
    }

    function closeModal(){ document.getElementById('modal').style.display='none'; }
    function setPlace(p){ tempPlace=p; updatePlaceUI(); }
    function toggleSpecial(){ tempSpecial = !tempSpecial; updateSpecialUI(); }

    function updateSpecialUI(){
        const btn = document.getElementById('btn-speciale');
        if(tempSpecial) btn.classList.add('active'); else btn.classList.remove('active');
    }

    function updatePlaceUI(){
        ['btn-cicci','btn-cucci','btn-separati','btn-fuori','btn-decidere'].forEach(id=>document.getElementById(id).classList.remove('active'));
        if(tempPlace === 'casa-cicci') document.getElementById('btn-cicci').classList.add('active');
        if(tempPlace === 'casa-cucci') document.getElementById('btn-cucci').classList.add('active');
        if(tempPlace === 'separati') document.getElementById('btn-separati').classList.add('active');
        if(tempPlace === 'fuori') document.getElementById('btn-fuori').classList.add('active');
        if(tempPlace === 'da-decidere') document.getElementById('btn-decidere').classList.add('active');
    }

    function previewFile() {
        const file = document.getElementById('photoInput').files[0];
        const imgPrev = document.getElementById('imgPreview');
        const vidPrev = document.getElementById('videoPreview');

        if (file) {
            fileToUpload = file;
            const reader = new FileReader();
            reader.onload = function(e){
                if(file.type.startsWith('video/')){
                    imgPrev.style.display = 'none';
                    vidPrev.src = e.target.result;
                    vidPrev.style.display = 'block';
                } else {
                    vidPrev.style.display = 'none';
                    imgPrev.src = e.target.result;
                    imgPrev.style.display = 'block';
                }
            }
            reader.readAsDataURL(file);
        }
    }

    async function uploadToGitHub(file) {
        if(!GH_TOKEN) { alert("Errore: Token GitHub mancante!"); return null; }
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
            reader.onload = async function() {
                const base64Content = reader.result.split(',')[1]; 
                let ext = "jpg";
                if(file.type.startsWith('video')) ext = "mp4"; 
                if(file.name.includes('.')) ext = file.name.split('.').pop();
                const fileName = `photos/${selectedDate}-${Date.now()}.${ext}`;
                const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${fileName}`;
                try {
                    const res = await fetch(url, {
                        method: 'PUT',
                        headers: {'Authorization': `Bearer ${GH_TOKEN}`, 'Content-Type': 'application/json'},
                        body: JSON.stringify({message: `Upload ${selectedDate}`, content: base64Content})
                    });
                    const json = await res.json();
                    if(!res.ok) throw new Error(json.message);
                    resolve(json.content?.download_url || `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/${fileName}`);
                } catch(e) { alert("Err GitHub: " + e.message); resolve(null); }
            };
            reader.readAsDataURL(file);
        });
    }

    async function saveDay(){
        const btn = document.getElementById('saveBtn'); btn.textContent = "Salvataggio..."; btn.disabled = true;
        let finalPhotoUrl = document.getElementById('currentPhotoUrl').value;

        if(fileToUpload) {
            btn.textContent = "Upload...";
            const uploadedUrl = await uploadToGitHub(fileToUpload);
            if(uploadedUrl) finalPhotoUrl = uploadedUrl; else { btn.textContent = "Errore Upload"; btn.disabled = false; return; }
        }

        db.collection('calendar').doc(selectedDate).set({
            place: tempPlace || null,
            isSpecial: tempSpecial,
            start: document.getElementById('startTime').value || "", 
            end: document.getElementById('endTime').value || "",
            note: document.getElementById('noteText').value || "",
            photoUrl: finalPhotoUrl || null,
            missed: false
        }).then(() => { closeModal(); btn.textContent = "Salva"; btn.disabled = false; });
    }

    function markAsMissedSingle() {
        if(confirm("Segna come 'Saltato'?")) {
            db.collection('calendar').doc(selectedDate).update({missed: true, place: null, start:"", end:"", isSpecial: false}).then(closeModal);
        }
    }

    function forceBalanceMonth(){
        if(!confirm("Riscrivi mese alternato (1 notte a testa)?")) return;
        const y=current.getFullYear(), m=current.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const batch = db.batch();
        for(let d=1; d<=days; d++){
            const key=`${y}-${m+1}-${d}`;
            const place = (d % 2 !== 0) ? 'casa-cicci' : 'casa-cucci';
            batch.set(db.collection('calendar').doc(key), { place: place, missed: false }, {merge: true}); 
        }
        batch.commit().then(() => alert("Fatto!"));
    }

    function shiftScheduleFromToday(){
        const today = new Date();
        const todayKey = `${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
        if(!confirm("Slittare tutto da OGGI in poi?")) return;

        db.collection('calendar').orderBy(firebase.firestore.FieldPath.documentId()).get().then(snap => {
            const updates = {}; let foundToday = false; let previousData = null;
            snap.docs.forEach((doc) => {
                const key = doc.id;
                if (key === todayKey) {
                    foundToday = true; previousData = doc.data(); 
                    updates[key] = { ...previousData, missed: true, place: null, start: "", end: "" };
                } else if (foundToday) {
                    const currentData = doc.data();
                    if (previousData) updates[key] = { ...previousData, missed: false };
                    previousData = currentData;
                }
            });
            const batch = db.batch(); Object.keys(updates).forEach(k => batch.set(db.collection('calendar').doc(k), updates[k]));
            return batch.commit();
        }).then(() => alert("Slittato!"));
    }

    function setAllToDecide(){
        if(!confirm("Tutto 'Da Decidere'?")) return;
        const y=current.getFullYear(), m=current.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const batch = db.batch();
        for(let d=1; d<=days; d++){
            batch.set(db.collection('calendar').doc(`${y}-${m+1}-${d}`), { place: 'da-decidere', missed: false }, {merge: true});
        }
        batch.commit().then(() => alert("Fatto!"));
    }

    function resetMonthColors(){
        if(!confirm("Reset colori? (Rimuove anche lo stato Speciale)")) return;
        const y=current.getFullYear(), m=current.getMonth();
        const days=new Date(y,m+1,0).getDate();
        const batch = db.batch();
        for(let d=1; d<=days; d++){
            batch.set(db.collection('calendar').doc(`${y}-${m+1}-${d}`), { place: null, start: "", end: "", missed: false, isSpecial: false }, {merge: true});
        }
        batch.commit().then(() => alert("Resettato!"));
    }

    function initializeMonth(){ db.collection('calendar').onSnapshot(snap=>{ let d={}; snap.docs.forEach(doc=>{d[doc.id]=doc.data()}); render(d); }); }
    function changeMonth(n){ current.setMonth(current.getMonth()+n); initializeMonth(); }
    
    function updateStats(){ 
        const y=current.getFullYear(), m=current.getMonth();
        db.collection('calendar').get().then(snap=>{ 
            let cicci=0, cucci=0, todecide=0, speciale=0, separati=0, fuori=0; 
            snap.forEach(d=>{ 
                const p = d.id.split('-');
                if(parseInt(p[0])===y && parseInt(p[1])===m+1 && !d.data().missed){
                    if(d.data().place==='casa-cicci') cicci++; 
                    else if(d.data().place==='casa-cucci') cucci++; 
                    else if(d.data().place==='separati') separati++;
                    else if(d.data().place==='fuori') fuori++;
                    else if(d.data().place==='da-decidere') todecide++; 
                    if(d.data().isSpecial) speciale++;
                }
            }); 
            document.getElementById('stats').innerHTML = `
                <div>üíú Cicci: <strong>${cicci}</strong></div>
                <div>‚ù§Ô∏è Cucci: <strong>${cucci}</strong></div>
                <div>üíî Separati: <strong>${separati}</strong></div>
                <div>‚õ∫ Fuori: <strong>${fuori}</strong></div>
                <div>‚ú® Speciali: <strong>${speciale}</strong></div>
                <div>ü§î Decidere: <strong>${todecide}</strong></div>
            `; 
        }); 
    }
</script>
</body>
</html>
